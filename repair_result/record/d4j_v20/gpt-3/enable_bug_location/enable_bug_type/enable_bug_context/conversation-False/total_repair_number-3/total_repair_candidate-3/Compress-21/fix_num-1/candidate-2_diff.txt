--- 
+++ 
@@ -1,4 +1,8 @@
 private void writeBits(final DataOutput header, final BitSet bits, final int length) throws IOException {
+    if (length < 0 || length > bits.size()) {
+        throw new IllegalArgumentException("Length must be non-negative and within the bounds of the BitSet size.");
+    }
+
     int cache = 0;
     int shift = 7;
     for (int i = 0; i < length; i++) {
@@ -10,7 +14,8 @@
             cache = 0;
         }
     }
-    if (length > 0 && shift > 0) {
+    if (length > 0 && shift < 7) {
         header.write(cache);
     }
 }
+
