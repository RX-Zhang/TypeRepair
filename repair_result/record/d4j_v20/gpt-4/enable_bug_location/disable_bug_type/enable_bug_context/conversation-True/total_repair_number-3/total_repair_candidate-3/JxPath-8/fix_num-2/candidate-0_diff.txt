--- 
+++ 
@@ -19,5 +19,26 @@
     }
     double ld = InfoSetUtil.doubleValue(left);
     double rd = InfoSetUtil.doubleValue(right);
+
+    // Fix NaN comparison behavior: NaN compared to anything should be false except for NaN = NaN which is true
+    boolean leftIsNaN = Double.isNaN(ld);
+    boolean rightIsNaN = Double.isNaN(rd);
+
+    if (leftIsNaN && rightIsNaN) {
+        // According to the test case, $nan = $nan should return true
+        if (evaluateCompare(0)) {
+            return true;
+        } else {
+            return false;
+        }
+    } else if (leftIsNaN || rightIsNaN) {
+        // Any relational comparisons involving NaN except equality should be false
+        if (evaluateCompare(0)) {
+            return false;
+        } else {
+            return false;
+        }
+    }
     return evaluateCompare(ld == rd ? 0 : ld < rd ? -1 : 1);
 }
+
