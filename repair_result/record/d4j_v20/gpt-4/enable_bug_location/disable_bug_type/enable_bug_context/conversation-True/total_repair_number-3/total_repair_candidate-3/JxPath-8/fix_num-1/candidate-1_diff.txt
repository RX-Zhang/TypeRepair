--- 
+++ 
@@ -19,5 +19,13 @@
     }
     double ld = InfoSetUtil.doubleValue(left);
     double rd = InfoSetUtil.doubleValue(right);
+    if (Double.isNaN(ld) || Double.isNaN(rd)) {
+        // According to the test cases, $nan = $nan should be true,
+        // but $nan > $nan and $nan < $nan should be false.
+        // So treat NaN comparisons as equals if both are NaN,
+        // otherwise comparisons involving NaN return false.
+        return (Double.isNaN(ld) && Double.isNaN(rd)) ? evaluateCompare(0) : evaluateCompare(Integer.MIN_VALUE);
+    }
     return evaluateCompare(ld == rd ? 0 : ld < rd ? -1 : 1);
 }
+
