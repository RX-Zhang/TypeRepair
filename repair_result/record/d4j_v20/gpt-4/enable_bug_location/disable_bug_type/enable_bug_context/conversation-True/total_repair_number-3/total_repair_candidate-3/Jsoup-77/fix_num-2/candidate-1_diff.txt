--- 
+++ 
@@ -14,8 +14,20 @@
 
     for (int pos = stack.size() -1; pos >= 0; pos--) {
         Element next = stack.get(pos);
-        stack.remove(pos);
-        if (next == firstFound)
+        if (next == firstFound) {
+            stack.remove(pos);
             break;
+        } else {
+            Element removed = stack.remove(pos);
+            // Reparent the children of removed element to the current top of the stack or to the parent of removed element 
+            if (!removed.childNodes().isEmpty()) {
+                Element insertTarget = stack.isEmpty() ? removed.parent() : stack.get(stack.size() -1);
+                for (Node child : removed.childNodes()) {
+                    child.setParentNode(insertTarget);
+                    insertTarget.appendChild(child);
+                }
+            }
+        }
     }
 }
+
