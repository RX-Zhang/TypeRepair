--- 
+++ 
@@ -1,5 +1,8 @@
 public char[] getTextBuffer()
 {
+    // Ensure buffer is not shared to avoid NullPointerException
+    ensureNotShared();
+
     // Are we just using shared input buffer?
     if (_inputStart >= 0) return _inputBuffer;
     if (_resultArray != null)  return _resultArray;
@@ -11,3 +14,4 @@
     // Nope, need to have/create a non-segmented array and return it
     return contentsAsArray();
 }
+
