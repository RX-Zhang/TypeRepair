--- 
+++ 
@@ -1,15 +1,18 @@
 public void escape(Writer writer, String str) throws IOException {
     int len = str.length();
     for (int i = 0; i < len; i++) {
-        char c = str.charAt(i);
-        String entityName = this.entityName(c);
+        int codepoint = str.codePointAt(i);
+        if (codepoint > 0xFFFF) {
+            i++; // skip the next char as it is part of this surrogate pair
+        }
+        String entityName = this.entityName(codepoint);
         if (entityName == null) {
-            if (c > 0x7F) {
+            if (codepoint > 0x7F) {
                 writer.write("&#");
-                writer.write(Integer.toString(c, 10));
+                writer.write(Integer.toString(codepoint, 10));
                 writer.write(';');
             } else {
-                writer.write(c);
+                writer.write(codepoint);
             }
         } else {
             writer.write('&');
@@ -18,3 +21,4 @@
         }
     }
 }
+
